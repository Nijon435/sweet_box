<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Secure Access</title>
    <link rel="icon" href="img/sweetbox_icon.ico" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="design.css" />
    <link rel="stylesheet" href="responsive.css" />
  </head>

  <body data-page="login">
    <section
      class="auth-overlay active"
      style="position: relative; min-height: 100vh"
    >
      <div class="auth-card">
        <img
          src="img/sweetbox_logo.png"
          alt="Sweet Box"
          class="auth-logo-top"
        />

        <!-- Login Form -->
        <div id="login-section">
          <div style="margin-bottom: 0.5rem">
            <h2 style="margin: 0">Sign in to manage operations</h2>
            <p style="margin: 0.25rem 0 0 0">
              Enter your email and password to access the system.
            </p>
          </div>
          <form id="login-form" class="auth-form">
            <label for="login-email">Email</label>
            <input
              id="login-email"
              type="email"
              placeholder="your.email@example.com"
              required
            />
            <label for="login-password">Password</label>
            <input
              id="login-password"
              type="password"
              placeholder="Enter your password"
              required
            />
            <p class="auth-error" id="login-error"></p>
            <button class="btn btn-primary" type="submit">Sign In</button>
          </form>
          <p class="meta login-meta-text">
            Don't have an account?
            <a href="#" id="show-register" class="login-link">Create Account</a>
          </p>
        </div>

        <!-- Register Form -->
        <div id="register-section" class="register-hidden">
          <div class="login-heading-container">
            <h2 class="login-heading">Create Your Account</h2>
            <p class="login-subtext">
              Fill in your details to create a new account.
            </p>
          </div>
          <form id="register-form" class="auth-form">
            <label for="register-name">Full Name</label>
            <input
              id="register-name"
              type="text"
              placeholder="Enter your full name"
              required
            />
            <label for="register-email">Email</label>
            <input
              id="register-email"
              type="email"
              placeholder="your.email@example.com"
              required
            />
            <label for="register-phone">Phone Number</label>
            <input
              id="register-phone"
              type="tel"
              placeholder="Enter your phone number"
              required
            />
            <label for="register-password">Password</label>
            <input
              id="register-password"
              type="password"
              placeholder="Create a password"
              minlength="6"
              required
            />
            <label for="register-password-confirm">Confirm Password</label>
            <input
              id="register-password-confirm"
              type="password"
              placeholder="Re-enter your password"
              required
            />
            <p class="auth-error" id="register-error"></p>
            <button class="btn btn-primary" type="submit">
              Create Account
            </button>
          </form>
          <p class="meta login-meta-text">
            Already have an account?
            <a href="#" id="show-login" class="login-link">Sign in</a>
          </p>
        </div>

        <!-- Password Reset Form (First-time login) -->
        <div id="password-reset-section" class="register-hidden">
          <div class="login-heading-container">
            <h2 class="login-heading">Reset Your Password</h2>
            <p class="login-subtext" style="color: #f59e0b">
              ⚠️ For security reasons, please change your password before
              continuing.
            </p>
          </div>
          <form id="password-reset-form" class="auth-form">
            <label for="reset-current-password">Current Password</label>
            <input
              id="reset-current-password"
              type="password"
              placeholder="Enter current password"
              required
            />
            <label for="reset-new-password">New Password</label>
            <input
              id="reset-new-password"
              type="password"
              placeholder="Create a new password"
              minlength="6"
              required
            />
            <label for="reset-confirm-password">Confirm New Password</label>
            <input
              id="reset-confirm-password"
              type="password"
              placeholder="Re-enter new password"
              required
            />
            <p class="auth-error" id="reset-error"></p>
            <button class="btn btn-primary" type="submit">
              Update Password
            </button>
          </form>
        </div>
      </div>
    </section>

    <script>
      // Auto-detect: Production vs Local
      if (
        window.location.hostname !== "localhost" &&
        window.location.hostname !== "127.0.0.1"
      ) {
        window.APP_STATE_ENDPOINT =
          "https://sweetbox-backend.onrender.com/api/state";
      } else {
        window.APP_STATE_ENDPOINT = "http://localhost:5000/api/state";
      }
    </script>
    <script src="js/common.js"></script>
    <script>
      // Wait for DOM to be fully loaded
      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", initLoginPage);
      } else {
        initLoginPage();
      }

      function initLoginPage() {
        console.log("=== LOGIN PAGE INITIALIZING ===");

        const loginSection = document.getElementById("login-section");
        const registerSection = document.getElementById("register-section");
        const passwordResetSection = document.getElementById(
          "password-reset-section"
        );
        const loginForm = document.getElementById("login-form");
        const registerForm = document.getElementById("register-form");
        const passwordResetForm = document.getElementById(
          "password-reset-form"
        );
        const showRegisterBtn = document.getElementById("show-register");
        const showLoginBtn = document.getElementById("show-login");

        console.log("Forms found:", {
          loginForm: !!loginForm,
          registerForm: !!registerForm,
          passwordResetForm: !!passwordResetForm,
        });

        let isDataLoaded = false;
        let currentUser = null; // Store user during password reset

        // Load user data first
        async function initializeData() {
          console.log("=== INITIALIZING DATA ===");
          console.log("Endpoint:", window.APP_STATE_ENDPOINT);

          try {
            // Show loading state
            if (loginForm) {
              const submitBtn = loginForm.querySelector(
                'button[type="submit"]'
              );
              if (submitBtn) {
                submitBtn.disabled = true;
                console.log("Login button disabled during load");
              }
            }
            if (registerForm) {
              const submitBtn = registerForm.querySelector(
                'button[type="submit"]'
              );
              if (submitBtn) {
                submitBtn.disabled = true;
                console.log("Register button disabled during load");
              }
            }

            // Fetch data from server
            console.log("Fetching data from server...");
            const response = await fetch(
              window.APP_STATE_ENDPOINT || "http://localhost:5000/api/state"
            );

            console.log("Server response status:", response.status);

            if (response.ok) {
              const data = await response.json();
              // Initialize appState globally
              window.appState = data;
              console.log(
                "✅ Loaded users from server:",
                data.users?.length || 0
              );
              if (data.users && data.users.length > 0) {
                console.log("First user sample:", {
                  email: data.users[0].email,
                  role: data.users[0].role,
                });
              }
              isDataLoaded = true;
            } else {
              console.error(
                "❌ Failed to load user data from server - Status:",
                response.status
              );
              // Try to load from localStorage as fallback
              if (typeof loadState === "function") {
                window.appState = loadState();
                console.log(
                  "Loaded from localStorage:",
                  window.appState?.users?.length || 0,
                  "users"
                );
                isDataLoaded = true;
              }
            }
          } catch (error) {
            console.error("❌ Error loading data:", error);
            // Fallback to localStorage
            if (typeof loadState === "function") {
              window.appState = loadState();
              console.log(
                "Fallback to localStorage:",
                window.appState?.users?.length || 0,
                "users"
              );
              isDataLoaded = true;
            }
          } finally {
            // Enable forms after data loads
            if (loginForm) {
              const submitBtn = loginForm.querySelector(
                'button[type="submit"]'
              );
              if (submitBtn) {
                submitBtn.disabled = false;
                console.log("Login button enabled");
              }
            }
            if (registerForm) {
              const submitBtn = registerForm.querySelector(
                'button[type="submit"]'
              );
              if (submitBtn) {
                submitBtn.disabled = false;
                console.log("Register button enabled");
              }
            }
            console.log("=== DATA INITIALIZATION COMPLETE ===");
          }
        }

        // Initialize on page load
        console.log("Calling initializeData...");
        initializeData();

        // Toggle between login and register
        if (showRegisterBtn) {
          showRegisterBtn.addEventListener("click", (e) => {
            e.preventDefault();
            loginSection.style.display = "none";
            registerSection.style.display = "block";
            document.getElementById("register-error").textContent = "";
          });
        }

        if (showLoginBtn) {
          showLoginBtn.addEventListener("click", (e) => {
            e.preventDefault();
            registerSection.style.display = "none";
            loginSection.style.display = "block";
            document.getElementById("login-error").textContent = "";
          });
        }

        // Handle Login
        if (loginForm) {
          console.log("✅ Login form event listener attached");
          loginForm.addEventListener("submit", async (event) => {
            event.preventDefault();
            console.log("=== LOGIN ATTEMPT ===");

            const email = document.getElementById("login-email").value.trim();
            const password = document.getElementById("login-password").value;
            const errorNode = document.getElementById("login-error");

            console.log("Login attempt for:", email);
            console.log("Password length:", password.length);

            if (!email || !password) {
              errorNode.textContent = "Please fill in all fields";
              console.log("❌ Validation failed: empty fields");
              return;
            }

            // Check if data is loaded
            console.log("Data loaded status:", isDataLoaded);
            console.log("appState exists:", typeof appState !== "undefined");
            console.log(
              "appState.users exists:",
              appState?.users ? "yes" : "no"
            );
            console.log("appState.users length:", appState?.users?.length || 0);

            if (
              !isDataLoaded ||
              typeof appState === "undefined" ||
              !appState.users
            ) {
              errorNode.textContent = "System loading, please wait...";
              console.log("❌ System not ready");
              return;
            }

            console.log(
              "Checking login against",
              appState.users.length,
              "users"
            );

            // Debug: Show all user emails
            console.log(
              "Available user emails:",
              appState.users.map((u) => u.email)
            );

            const user = appState.users.find(
              (u) => u.email === email && u.password === password
            );

            if (!user) {
              errorNode.textContent = "Invalid email or password";
              console.log("❌ Login failed for:", email);
              // Try to find by email only to see if email exists
              const emailMatch = appState.users.find((u) => u.email === email);
              if (emailMatch) {
                console.log("Email found but password mismatch");
                console.log("Stored password:", emailMatch.password);
                console.log("Entered password:", password);
              } else {
                console.log("Email not found in database");
              }
              return;
            }

            console.log("✅ Login successful for:", user.name);

            // Check if this is first-time login (password needs to be reset)
            // Admin-created accounts have requirePasswordReset flag
            if (user.requirePasswordReset) {
              console.log("⚠️ First-time login - password reset required");
              currentUser = user;

              // Show password reset form
              loginSection.style.display = "none";
              passwordResetSection.style.display = "block";
              document.getElementById("reset-error").textContent = "";
              document.getElementById("reset-current-password").value = "";
              document.getElementById("reset-new-password").value = "";
              document.getElementById("reset-confirm-password").value = "";
              return;
            }

            // Set session
            if (typeof setSession === "function") {
              setSession(user.id);
              const landing =
                typeof getLandingPageForRole === "function"
                  ? getLandingPageForRole(user.role)
                  : "index.html";
              console.log("Redirecting to:", landing);
              window.location.href = landing;
            } else {
              errorNode.textContent = "Authentication system error";
              console.log("❌ setSession function not found");
            }
          });
        } else {
          console.log("❌ Login form not found!");
        }

        // Handle Registration
        if (registerForm) {
          registerForm.addEventListener("submit", async (event) => {
            event.preventDefault();
            const name = document.getElementById("register-name").value.trim();
            const email = document
              .getElementById("register-email")
              .value.trim();
            const phone = document
              .getElementById("register-phone")
              .value.trim();
            const password = document.getElementById("register-password").value;
            const confirmPassword = document.getElementById(
              "register-password-confirm"
            ).value;
            const errorNode = document.getElementById("register-error");

            // Validation
            if (!name || !email || !phone || !password || !confirmPassword) {
              errorNode.textContent = "Please fill in all fields";
              return;
            }

            if (password !== confirmPassword) {
              errorNode.textContent = "Passwords do not match";
              return;
            }

            if (password.length < 6) {
              errorNode.textContent = "Password must be at least 6 characters";
              return;
            }

            // Check if data is loaded
            if (
              !isDataLoaded ||
              typeof appState === "undefined" ||
              !appState.users
            ) {
              errorNode.textContent = "System loading, please wait...";
              return;
            }

            // Check if email already exists
            if (appState.users.find((u) => u.email === email)) {
              errorNode.textContent = "Email already registered";
              return;
            }

            // Create new user with default role: front_staff
            const newUser = {
              id: "user-" + Date.now(),
              name: name,
              email: email,
              phone: phone,
              password: password, // In production, this should be hashed
              role: "staff",
              permission: "front_staff",
              status: "active",
              createdAt: new Date().toISOString(),
            };

            appState.users.push(newUser);
            console.log("New user created:", newUser.email);

            // Disable submit button to prevent double submission
            const submitBtn = registerForm.querySelector(
              'button[type="submit"]'
            );
            if (submitBtn) {
              submitBtn.disabled = true;
              submitBtn.textContent = "Creating Account...";
            }

            // Save to database
            try {
              // Force immediate sync to database
              await syncStateToDatabase();
              console.log("User saved to database successfully");

              // Auto login after registration
              if (typeof setSession === "function") {
                setSession(newUser.id);
                const landing =
                  typeof getLandingPageForRole === "function"
                    ? getLandingPageForRole(newUser.role)
                    : "index.html";
                window.location.href = landing;
              }
            } catch (error) {
              console.error("Error saving user:", error);
              errorNode.textContent =
                "Failed to create account. Please try again.";
              // Remove user from array if save failed
              const index = appState.users.findIndex(
                (u) => u.id === newUser.id
              );
              if (index > -1) {
                appState.users.splice(index, 1);
              }
              if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.textContent = "Create Account";
              }
            }
          });
        }

        // Handle Password Reset (First-time login)
        if (passwordResetForm) {
          passwordResetForm.addEventListener("submit", async (event) => {
            event.preventDefault();
            const currentPassword = document.getElementById(
              "reset-current-password"
            ).value;
            const newPassword =
              document.getElementById("reset-new-password").value;
            const confirmPassword = document.getElementById(
              "reset-confirm-password"
            ).value;
            const errorNode = document.getElementById("reset-error");

            // Validation
            if (!currentPassword || !newPassword || !confirmPassword) {
              errorNode.textContent = "Please fill in all fields";
              return;
            }

            if (currentPassword !== currentUser.password) {
              errorNode.textContent = "Current password is incorrect";
              return;
            }

            if (newPassword !== confirmPassword) {
              errorNode.textContent = "New passwords do not match";
              return;
            }

            if (newPassword.length < 6) {
              errorNode.textContent = "Password must be at least 6 characters";
              return;
            }

            if (newPassword === currentPassword) {
              errorNode.textContent =
                "New password must be different from current password";
              return;
            }

            // Update password in appState
            const userIndex = appState.users.findIndex(
              (u) => u.id === currentUser.id
            );
            if (userIndex === -1) {
              errorNode.textContent = "User not found";
              return;
            }

            appState.users[userIndex].password = newPassword;
            appState.users[userIndex].requirePasswordReset = false;

            console.log("✅ Password updated for:", currentUser.email);

            // Disable submit button
            const submitBtn = passwordResetForm.querySelector(
              'button[type="submit"]'
            );
            if (submitBtn) {
              submitBtn.disabled = true;
              submitBtn.textContent = "Updating...";
            }

            // Save to database
            try {
              await syncStateToDatabase();
              console.log("Password change saved to database");

              // Log in the user after password reset
              if (typeof setSession === "function") {
                setSession(currentUser.id);
                const landing =
                  typeof getLandingPageForRole === "function"
                    ? getLandingPageForRole(currentUser.role)
                    : "index.html";
                console.log("Redirecting to:", landing);
                window.location.href = landing;
              }
            } catch (error) {
              console.error("Error saving password:", error);
              errorNode.textContent =
                "Failed to update password. Please try again.";

              // Revert changes
              appState.users[userIndex].password = currentPassword;
              appState.users[userIndex].requirePasswordReset = true;

              if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.textContent = "Update Password";
              }
            }
          });
        }

        console.log("=== LOGIN PAGE INITIALIZATION COMPLETE ===");
      }
    </script>
  </body>
</html>
