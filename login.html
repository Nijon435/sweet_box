<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Secure Access</title>
    <link rel="icon" href="img/sweetbox_icon.ico" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="design.css" />
    <link rel="stylesheet" href="responsive.css" />
  </head>

  <body data-page="login">
    <section
      class="auth-overlay active"
      style="position: relative; min-height: 100vh"
    >
      <div class="auth-card">
        <img
          src="img/sweetbox_logo.png"
          alt="Sweet Box"
          class="auth-logo-top"
        />

        <!-- Login Form -->
        <div id="login-section">
          <div style="margin-bottom: 0.5rem">
            <h2 style="margin: 0">Sign in to manage operations</h2>
            <p style="margin: 0.25rem 0 0 0">
              Enter your email and password to access the system.
            </p>
          </div>
          <form id="login-form" class="auth-form">
            <label for="login-email">Email</label>
            <input
              id="login-email"
              type="email"
              placeholder="your.email@example.com"
              required
            />
            <label for="login-password">Password</label>
            <input
              id="login-password"
              type="password"
              placeholder="Enter your password"
              required
            />
            <p class="auth-error" id="login-error"></p>
            <button class="btn btn-primary" type="submit">Sign In</button>
          </form>
          <p class="meta login-meta-text">
            Don't have an account?
            <a href="#" id="show-register" class="login-link">Create Account</a>
          </p>
        </div>

        <!-- Register Form -->
        <div id="register-section" class="register-hidden">
          <div class="login-heading-container">
            <h2 class="login-heading">Create Your Account</h2>
            <p class="login-subtext">
              Fill in your details to create a new account.
            </p>
          </div>
          <form id="register-form" class="auth-form">
            <label for="register-name">Full Name</label>
            <input
              id="register-name"
              type="text"
              placeholder="Enter your full name"
              required
            />
            <label for="register-email">Email</label>
            <input
              id="register-email"
              type="email"
              placeholder="your.email@example.com"
              required
            />
            <label for="register-phone">Phone Number</label>
            <input
              id="register-phone"
              type="tel"
              placeholder="Enter your phone number"
              required
            />
            <label for="register-password">Password</label>
            <input
              id="register-password"
              type="password"
              placeholder="Create a password"
              minlength="6"
              required
            />
            <label for="register-password-confirm">Confirm Password</label>
            <input
              id="register-password-confirm"
              type="password"
              placeholder="Re-enter your password"
              required
            />
            <p class="auth-error" id="register-error"></p>
            <button class="btn btn-primary" type="submit">
              Create Account
            </button>
          </form>
          <p class="meta login-meta-text">
            Already have an account?
            <a href="#" id="show-login" class="login-link">Sign in</a>
          </p>
        </div>
      </div>
    </section>

    <script>
      // Auto-detect: Production vs Local
      if (
        window.location.hostname !== "localhost" &&
        window.location.hostname !== "127.0.0.1"
      ) {
        window.APP_STATE_ENDPOINT =
          "https://sweetbox-backend.onrender.com/api/state";
      } else {
        window.APP_STATE_ENDPOINT = "http://localhost:5000/api/state";
      }
    </script>
    <script src="js/common.js"></script>
    <script>
      (function initLoginPage() {
        const loginSection = document.getElementById("login-section");
        const registerSection = document.getElementById("register-section");
        const loginForm = document.getElementById("login-form");
        const registerForm = document.getElementById("register-form");
        const showRegisterBtn = document.getElementById("show-register");
        const showLoginBtn = document.getElementById("show-login");

        // Load user data first
        async function initializeData() {
          try {
            // Fetch data from server
            const response = await fetch(
              window.APP_STATE_ENDPOINT || "http://localhost:5000/api/state"
            );
            if (response.ok) {
              const data = await response.json();
              // Initialize appState with users
              if (typeof appState !== "undefined") {
                appState.users = data.users || [];
              } else {
                window.appState = { users: data.users || [] };
              }
              console.log("Loaded", appState.users.length, "users");
            } else {
              console.error("Failed to load user data");
            }
          } catch (error) {
            console.error("Error loading data:", error);
          }
        }

        // Initialize on page load
        initializeData();

        // Toggle between login and register
        if (showRegisterBtn) {
          showRegisterBtn.addEventListener("click", (e) => {
            e.preventDefault();
            loginSection.style.display = "none";
            registerSection.style.display = "block";
            document.getElementById("register-error").textContent = "";
          });
        }

        if (showLoginBtn) {
          showLoginBtn.addEventListener("click", (e) => {
            e.preventDefault();
            registerSection.style.display = "none";
            loginSection.style.display = "block";
            document.getElementById("login-error").textContent = "";
          });
        }

        // Handle Login
        if (loginForm) {
          loginForm.addEventListener("submit", async (event) => {
            event.preventDefault();
            const email = document.getElementById("login-email").value.trim();
            const password = document.getElementById("login-password").value;
            const errorNode = document.getElementById("login-error");

            if (!email || !password) {
              errorNode.textContent = "Please fill in all fields";
              return;
            }

            // Check against appState.users
            if (typeof appState === "undefined" || !appState.users) {
              errorNode.textContent = "System not ready. Please try again.";
              return;
            }

            const user = appState.users.find(
              (u) => u.email === email && u.password === password
            );

            if (!user) {
              errorNode.textContent = "Invalid email or password";
              return;
            }

            // Set session
            if (typeof setSession === "function") {
              setSession(user.id);
              const landing =
                typeof getLandingPageForRole === "function"
                  ? getLandingPageForRole(user.role)
                  : "index.html";
              window.location.href = landing;
            } else {
              errorNode.textContent = "Authentication system error";
            }
          });
        }

        // Handle Registration
        if (registerForm) {
          registerForm.addEventListener("submit", async (event) => {
            event.preventDefault();
            const name = document.getElementById("register-name").value.trim();
            const email = document
              .getElementById("register-email")
              .value.trim();
            const phone = document
              .getElementById("register-phone")
              .value.trim();
            const password = document.getElementById("register-password").value;
            const confirmPassword = document.getElementById(
              "register-password-confirm"
            ).value;
            const errorNode = document.getElementById("register-error");

            // Validation
            if (!name || !email || !phone || !password || !confirmPassword) {
              errorNode.textContent = "Please fill in all fields";
              return;
            }

            if (password !== confirmPassword) {
              errorNode.textContent = "Passwords do not match";
              return;
            }

            if (password.length < 6) {
              errorNode.textContent = "Password must be at least 6 characters";
              return;
            }

            // Check if email already exists
            if (typeof appState === "undefined" || !appState.users) {
              errorNode.textContent = "System not ready. Please try again.";
              return;
            }

            if (appState.users.find((u) => u.email === email)) {
              errorNode.textContent = "Email already registered";
              return;
            }

            // Create new user with default role: kitchen_staff
            const newUser = {
              id: "user-" + Date.now(),
              name: name,
              email: email,
              phone: phone,
              password: password, // In production, this should be hashed
              role: "kitchen_staff",
              permission: "kitchen_staff",
              status: "active",
              createdAt: new Date().toISOString(),
            };

            appState.users.push(newUser);

            // Save to database synchronously before navigation
            if (
              typeof saveState === "function" &&
              typeof syncStateToDatabase === "function"
            ) {
              saveState();
              // Force immediate sync to database
              syncStateToDatabase()
                .then(() => {
                  console.log("User saved to database");
                  // Auto login after registration and save
                  if (typeof setSession === "function") {
                    setSession(newUser.id);
                    const landing =
                      typeof getLandingPageForRole === "function"
                        ? getLandingPageForRole(
                            newUser.permission || newUser.role
                          )
                        : "index.html";
                    window.location.href = landing;
                  }
                })
                .catch((err) => {
                  console.error("Failed to save user:", err);
                  errorNode.textContent =
                    "Failed to create account. Please try again.";
                });
            } else {
              errorNode.textContent =
                "System error. Please refresh and try again.";
            }
          });
        }
      })();
    </script>
  </body>
</html>
